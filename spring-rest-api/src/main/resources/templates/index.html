<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Quản lý User</title>
</head>

<body>
    <div class="container mt-5 mb-5">
        <h2 class="text-center text-uppercase">Danh sách user</h2>

        <div class="row justify-content-center">
            <div class="col-md-10">

                <div class="d-flex justify-content-between align-items-center mt-5 mb-4">
                    <a th:href="@{/api/v2/users/create}" class="btn btn-warning">Tạo user</a>
                    <input type="text" id="search" class="form-control w-50" placeholder="Tìm kiếm user" onkeyup="searchUser()" />
                </div>

                <div class="bg-light p-4">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr th:each="user : ${users}">
                                <td th:text="${user.id}">1</td>
                                <td th:text="${user.name}">Nguyễn Văn A</td>
                                <td th:text="${user.email}">a@gmail.com</td>
                                <td th:text="${user.phone}">0987654321</td>
                                <td th:text="${user.address}">Hà Nội</td>
                                <td>
                                    <a th:href="@{/api/v2/users/{id} (id = ${user.id})}" class="btn btn-success">Xem chi tiết</a>
                                    <button class="btn btn-danger" th:onclick="'deleteUser(' + ${user.id} + ', this)'">Xóa</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <p class="message d-none"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script th:inline="javascript" >
        // Chức năng tìm kiếm theo tên
        function searchUser() {
            const searchInput = document.getElementById("search");
            const searchValue = searchInput.value;

            // Ánh xạ giá trị tìm kiếm lên thanh tìm kiếm URL
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set("name", searchValue); // Tạo param name trên thanh URL
            const newURL = window.location.pathname + "?" + urlParams.toString(); //URL mới
            window.history.pushState({ path: newURL }, "", newURL); //Cập nhật URL mới

            // Gửi yêu cầu tìm kiếm và cập nhật dữ liệu trả về
            axios.get(`/api/v1/users/search?name=${searchValue}`)
                .then(function (response) {
                    const users = response.data;
                    const tableBody = document.querySelector("tbody");
                    tableBody.innerHTML = "";

                    users.forEach(function (user, index) {
                        const newRow = document.createElement("tr");
                        newRow.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>${user.address}</td>
                        <td>
                            <a href="/api/v1/users/${user.id}" class="btn btn-success">Xem chi tiết</a>
                            <button class="btn btn-danger" th:onclick="'deleteUser(' + ${user.id} + ', this)'">Xóa</button>
                        </td>
                    `;
                        tableBody.appendChild(newRow);
                    });

                    // Cập nhật URL trang web với giá trị tìm kiếm
                    history.replaceState(null, "", newURL);
                })
                .catch(function (error) {
                    console.error(error);
                });
        }

        // Kiểm tra nếu có giá trị tìm kiếm trong URL khi trang được tải lại
        window.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search); // Lấy giá trị trên URL
            const searchValue = urlParams.get("name");                      // Lấy param name
            if (searchValue) { // Kiểm tra nếu name tồn tại
                document.getElementById("search").value = searchValue; // Thực hiện tìm kiếm trên thanh tìm kiếm bằng giá trị name của URL
                searchUser();
            }
        });



        //Xóa user
        function deleteUser(userId, buttonElement) {
            if (confirm("Bạn có chắc muốn xóa người dùng này?")) {
                axios.delete(`/api/v1/users/${userId}`)
                    .then(function () {
                        // Xóa dòng của người dùng khỏi danh sách trên giao diện người dùng
                        const row = buttonElement.closest("tr");
                        row.remove();
                        alert("Xóa thành công!");
                    })
                    .catch(function (error) {
                        console.error(error);
                        alert("Xóa thất bại. Vui lòng thử lại sau.");
                    });
            }
        }

    </script>
</body>

</html>